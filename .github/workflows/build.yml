name: Build PulseAudio for Android

on:
  workflow_dispatch: # Permite rodar o script manualmente na aba Actions

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64, armhf]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build pkg-config libtool automake autoconf gettext wget xz-utils

    - name: Cross-Compile PulseAudio
      run: |
        export NDK_PATH=$ANDROID_NDK_LATEST_HOME
        export BASE_DIR=$PWD
        export arch=${{ matrix.arch }}
        export ROOT_DIR="$BASE_DIR/root-$arch"
        export PATH=$ROOT_DIR/bin:$PATH
        export PKG_CONFIG_PATH=$ROOT_DIR/lib/pkgconfig
        
        # Injetando as pastas de include para as dependências se encontrarem
        export CFLAGS="-O2 -I$ROOT_DIR/include"
        export LDFLAGS="-L$ROOT_DIR/lib"

        if [ "$arch" = "arm64" ]; then
          BUILDCHAIN=aarch64-linux-android
          OUTPUT_DIR="$BASE_DIR/output/aarch64-linux-gnu"
          MESON_CPU_FAMILY="aarch64"
          MESON_CPU="armv8-a"
          API_LEVEL=26
        else
          BUILDCHAIN=armv7a-linux-androideabi
          OUTPUT_DIR="$BASE_DIR/output/arm-linux-gnueabihf"
          MESON_CPU_FAMILY="arm"
          MESON_CPU="armv7-a"
          API_LEVEL=26
        fi

        export TOOLCHAIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
        export CC="$TOOLCHAIN/${BUILDCHAIN}${API_LEVEL}-clang"
        export CXX="$TOOLCHAIN/${BUILDCHAIN}${API_LEVEL}-clang++"
        export AR="$TOOLCHAIN/llvm-ar"
        export STRIP="$TOOLCHAIN/llvm-strip"

        # =========================================================
        # TRUQUE ANTI-ERRO: Criar Header Dummy para o libintl (gettext)
        # O Android não tem isso nativamente, então criamos macros vazias.
        # =========================================================
        # =========================================================
        # TRUQUE ANTI-ERRO: Criar Header Dummy para o libintl (gettext)
        # =========================================================
        mkdir -p $ROOT_DIR/include
        cat <<EOF > $ROOT_DIR/include/libintl.h
        #ifndef LIBINTL_H
        #define LIBINTL_H
        #define textdomain(Domain) (Domain)
        #define bindtextdomain(Package, Directory) (Package)
        #define bind_textdomain_codeset(Domain, Codeset) (Codeset)
        #define dgettext(Domain, String) (String)
        #define dcgettext(Domain, String, Category) (String)
        #define ngettext(Msgid1, Msgid2, N) ((N) == 1 ? (Msgid1) : (Msgid2))
        #define dngettext(Domain, Msgid1, Msgid2, N) ((N) == 1 ? (Msgid1) : (Msgid2))
        #define dcngettext(Domain, Msgid1, Msgid2, N, Category) ((N) == 1 ? (Msgid1) : (Msgid2))
        #define gettext(String) (String)
        #endif
        EOF




        # 1. Construir libtool (ltdl)
        wget https://ftpmirror.gnu.org/libtool/libtool-2.4.7.tar.gz
        tar -xf libtool-2.4.7.tar.gz
        pushd libtool-2.4.7
        ./configure --host=$BUILDCHAIN --prefix=$ROOT_DIR HELP2MAN=/bin/true MAKEINFO=/bin/true
        make -j$(nproc)
        make install
        popd

        # 2. Construir libsndfile
        wget https://github.com/libsndfile/libsndfile/releases/download/1.2.2/libsndfile-1.2.2.tar.xz
        tar -xf libsndfile-1.2.2.tar.xz
        pushd libsndfile-1.2.2
        ./configure --host=$BUILDCHAIN --prefix=$ROOT_DIR --disable-external-libs --disable-alsa --disable-sqlite
        make -j$(nproc)
        make install
        popd

        # 3. Baixar PulseAudio Upstream (v17.0)
        git clone https://gitlab.freedesktop.org/pulseaudio/pulseaudio.git
        pushd pulseaudio
        git checkout v17.0

        # TRUQUE 2: Remover a exigência da libintl do script do Meson
        sed -i "s/cc.find_library('intl')/\[\]/g" meson.build

        # TRUQUE 3: Desativar execinfo/backtrace (o linker do Android engana o teste, mas falha no header)
        # TRUQUE 3: Desativar execinfo/backtrace (o linker do Android engana o teste, mas falha no header)
        # Substituímos a string de busca para algo que com certeza não existe no sistema
        sed -i "s/'backtrace'/'bug_backtrace'/g" meson.build
        sed -i "s/'execinfo.h'/'bug_execinfo.h'/g" meson.build
        # O Meson cross-file com os paths corretos passados nas opções built-in
        cat <<EOF > ../android-cross-$arch.txt
        [binaries]
        c = '$CC'
        cpp = '$CXX'
        ar = '$AR'
        strip = '$STRIP'
        pkgconfig = 'pkg-config'

        [built-in options]
        c_args = ['-O2', '-I$ROOT_DIR/include']
        cpp_args = ['-O2', '-I$ROOT_DIR/include']
        c_link_args = ['-L$ROOT_DIR/lib']
        cpp_link_args = ['-L$ROOT_DIR/lib']

        [host_machine]
        system = 'android'
        cpu_family = '$MESON_CPU_FAMILY'
        cpu = '$MESON_CPU'
        endian = 'little'
        EOF

        # 4. Configurar e Compilar com Meson
        meson setup build-$arch --cross-file ../android-cross-$arch.txt --prefix=$ROOT_DIR \
          -Ddefault_library=shared -Ddatabase=simple \
          -Dalsa=disabled -Dx11=disabled -Ddbus=disabled -Dglib=disabled \
          -Dgtk=disabled -Dsystemd=disabled -Dudev=disabled -Dopenssl=disabled \
          -Dtests=false -Dman=false -Ddaemon=false -Doss-output=disabled -Ddoxygen=false

        meson compile -C build-$arch
        meson install -C build-$arch
        popd

        # 5. Organizar arquivos para o Artefato
        mkdir -p release/$arch/modules
        PA_VERSION="17.0"

        cp -a $ROOT_DIR/bin/pulseaudio release/$arch/libpulseaudio.so
        cp -a $ROOT_DIR/bin/pactl release/$arch/pactl

        cp -a $ROOT_DIR/lib/pulseaudio/libpulsecommon-${PA_VERSION}.so release/$arch/libpulsecommon-${PA_VERSION}.so
        cp -a $ROOT_DIR/lib/pulseaudio/libpulsecore-${PA_VERSION}.so release/$arch/libpulsecore-${PA_VERSION}.so
        cp -a $ROOT_DIR/lib/libpulse.so release/$arch/libpulse.so
        cp -a $ROOT_DIR/lib/libsndfile.so release/$arch/libsndfile.so
        cp -a $ROOT_DIR/lib/libltdl.so release/$arch/libltdl.so

        cp -a $ROOT_DIR/lib/pulse-${PA_VERSION}/modules/libprotocol-native.so release/$arch/modules/libprotocol-native.so
        cp -a $ROOT_DIR/lib/pulse-${PA_VERSION}/modules/module-native-protocol-unix.so release/$arch/modules/module-native-protocol-unix.so

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pulseaudio-android-${{ matrix.arch }}
        path: release/${{ matrix.arch }}/*
